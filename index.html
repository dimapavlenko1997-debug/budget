<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Семейный бюджет</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 10px;
            padding-bottom: env(safe-area-inset-bottom);
            -webkit-text-size-adjust: 100%;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 20px;
            text-align: center;
            padding-top: max(20px, env(safe-area-inset-top));
        }
        
        h1 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .month-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }
        
        .month-navigation button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-touch-callout: none;
        }
        
        .month-navigation button:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.95);
        }
        
        .current-month {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .income-type-toggle {
            display: flex;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 4px;
            margin-top: 10px;
        }
        
        .income-type-btn {
            flex: 1;
            background: none;
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            font-weight: 500;
            -webkit-touch-callout: none;
        }
        
        .income-type-btn.active {
            background: white;
            color: #6a11cb;
        }
        
        .income-type-btn:active {
            transform: scale(0.95);
        }
        
        .summary {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .summary-item {
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
            -webkit-touch-callout: none;
        }
        
        .summary-item:active {
            transform: scale(0.95);
        }
        
        .summary-value {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .income {
            color: #28a745;
        }
        
        .expenses {
            color: #dc3545;
        }
        
        .balance {
            color: #007bff;
        }
        
        .tabs {
            display: flex;
            background-color: #f8f9fa;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 14px 12px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
            min-width: 120px;
            font-size: 0.9rem;
            font-weight: 500;
            -webkit-touch-callout: none;
        }
        
        .tab.active {
            border-bottom: 2px solid #6a11cb;
            color: #6a11cb;
            font-weight: 600;
        }
        
        .tab:active {
            background-color: rgba(106, 17, 203, 0.1);
        }
        
        .content {
            padding: 15px;
        }
        
        .transaction-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        input, select {
            padding: 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            -webkit-appearance: none;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #6a11cb;
            box-shadow: 0 0 0 2px rgba(106, 17, 203, 0.1);
        }
        
        button {
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            -webkit-touch-callout: none;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background-color: #6a11cb;
            color: white;
        }
        
        .btn-primary:active {
            background-color: #5a0db3;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:active {
            background-color: #5a6268;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-danger:active {
            background-color: #c82333;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-success:active {
            background-color: #218838;
        }
        
        .back-button {
            background: none;
            border: none;
            color: #6a11cb;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 15px;
            padding: 8px 0;
            font-weight: 500;
            -webkit-touch-callout: none;
        }
        
        .back-button:active {
            color: #5a0db3;
            transform: scale(0.98);
        }
        
        .distribution-section {
            margin-top: 20px;
        }
        
        .distribution-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .distribution-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .distribution-category {
            flex: 1;
            font-size: 0.95rem;
        }
        
        .distribution-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .distribution-percent {
            width: 70px;
            text-align: right;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
            -webkit-appearance: none;
        }
        
        .distribution-amount {
            font-weight: 600;
            color: #6a11cb;
            width: 100px;
            text-align: right;
            font-size: 0.9rem;
        }
        
        .progress-bar {
            height: 6px;
            background-color: #e9ecef;
            border-radius: 3px;
            margin-top: 6px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #6a11cb;
            border-radius: 3px;
        }
        
        .distribution-summary {
            margin-top: 20px;
            padding: 16px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px 20px;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .import-export {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .import-export button {
            flex: 1;
        }
        
        .distribution-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .distribution-actions button {
            flex: 1;
        }
        
        .add-category-btn {
            background: none;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 1.5rem;
            color: #6a11cb;
            background-color: rgba(106, 17, 203, 0.1);
            -webkit-touch-callout: none;
        }
        
        .add-category-btn:active {
            background-color: rgba(106, 17, 203, 0.2);
            transform: scale(0.95);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .close-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-touch-callout: none;
        }
        
        .close-button:active {
            color: #495057;
            transform: scale(0.95);
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .copy-month-section {
            margin-top: 20px;
            padding: 16px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .category-actions {
            display: flex;
            gap: 6px;
        }
        
        .action-btn {
            padding: 8px 12px;
            font-size: 0.8rem;
            border-radius: 6px;
        }
        
        .operations-list {
            max-height: 50vh;
            overflow-y: auto;
            margin-top: 15px;
            -webkit-overflow-scrolling: touch;
        }
        
        .operation-item {
            display: flex;
            justify-content: space-between;
            padding: 14px;
            border-bottom: 1px solid #e9ecef;
            align-items: center;
        }
        
        .operation-item:last-child {
            border-bottom: none;
        }
        
        .operation-info {
            flex: 1;
        }
        
        .operation-category {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .operation-amount.income {
            color: #28a745;
            font-weight: 600;
        }
        
        .operation-amount.expense {
            color: #dc3545;
            font-weight: 600;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1.2rem;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-touch-callout: none;
        }
        
        .delete-btn:active {
            color: #c82333;
            transform: scale(0.95);
        }
        
        /* iPhone оптимизация */
        @media (max-width: 480px) {
            .container {
                border-radius: 0;
                box-shadow: none;
            }
            
            header {
                padding: 15px;
                padding-top: max(15px, env(safe-area-inset-top));
            }
            
            .content {
                padding: 12px;
            }
            
            .tabs {
                overflow-x: auto;
            }
            
            .distribution-controls {
                flex-direction: column;
                gap: 6px;
            }
            
            .distribution-percent, .distribution-amount {
                width: 80px;
            }
            
            .month-navigation button {
                width: 44px;
                height: 44px;
            }
            
            input, select, button {
                padding: 16px;
            }
            
            .tab {
                padding: 16px 12px;
            }
            
            .distribution-item {
                padding: 16px 0;
            }
        }
        
        /* Поддержка безопасных зон на iPhone X и новее */
        @supports(padding: max(0px)) {
            .container {
                padding-left: max(10px, env(safe-area-inset-left));
                padding-right: max(10px, env(safe-area-inset-right));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Семейный бюджет</h1>
            <div class="month-navigation">
                <button id="prev-month">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>
                <div class="current-month" id="current-month">Январь 2023</div>
                <button id="next-month">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
            <div class="income-type-toggle">
                <button class="income-type-btn active" data-type="salary">Зарплата</button>
                <button class="income-type-btn" data-type="advance">Аванс</button>
            </div>
        </header>
        
        <div class="summary">
            <div class="summary-item" id="income-summary">
                <div>Доходы</div>
                <div class="summary-value income" id="total-income">0 ₽</div>
            </div>
            <div class="summary-item" id="expenses-summary">
                <div>Расходы</div>
                <div class="summary-value expenses" id="total-expenses">0 ₽</div>
            </div>
            <div class="summary-item">
                <div>Баланс</div>
                <div class="summary-value balance" id="total-balance">0 ₽</div>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="add">Добавить операцию</div>
            <div class="tab" data-tab="distribution">Распределение</div>
            <div class="tab" data-tab="expenses">Расходы</div>
        </div>
        
        <div class="content">
            <div id="add-tab" class="tab-content">
                <form class="transaction-form" id="transaction-form">
                    <div class="form-group">
                        <label for="type">Тип операции</label>
                        <select id="type" required>
                            <option value="income">Доход</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="category">Категория</label>
                        <select id="category" required>
                            <!-- Категории будут заполняться динамически -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="amount">Сумма (₽)</label>
                        <input type="number" id="amount" min="0" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="date">Дата</label>
                        <input type="date" id="date" required>
                    </div>
                    
                    <button type="submit" class="btn-primary">Добавить операцию</button>
                </form>
                
                <div class="import-export">
                    <button class="btn-secondary" id="export-btn">Экспорт в Excel</button>
                    <button class="btn-secondary" id="import-btn">Импорт из Excel</button>
                </div>
            </div>
            
            <div id="distribution-tab" class="tab-content" style="display: none;">
                <div class="distribution-section">
                    <div class="distribution-header">
                        <h3>Распределение доходов</h3>
                        <button class="add-category-btn" id="add-category-btn" title="Добавить категорию">+</button>
                    </div>
                    
                    <div id="distribution-list">
                        <!-- Распределение по категориям будет здесь -->
                    </div>
                    
                    <div class="distribution-summary">
                        <div class="summary-row">
                            <div>Общий доход:</div>
                            <div id="total-income-summary">0 ₽</div>
                        </div>
                        <div class="summary-row">
                            <div>Уже распределено:</div>
                            <div id="allocated-summary">0 ₽</div>
                        </div>
                        <div class="summary-row">
                            <div>Доступно для распределения:</div>
                            <div id="available-summary">0 ₽</div>
                        </div>
                        <div class="summary-row">
                            <div>Использовано процентов:</div>
                            <div id="used-percent">0%</div>
                        </div>
                    </div>
                    
                    <div class="distribution-actions">
                        <button class="btn-primary" id="apply-distribution">Применить распределение</button>
                    </div>
                    
                    <div class="copy-month-section">
                        <h4>Копирование данных</h4>
                        <p>Скопировать распределение из предыдущего месяца:</p>
                        <button class="btn-secondary" id="copy-prev-month">Копировать из прошлого месяца</button>
                    </div>
                </div>
            </div>
            
            <div id="expenses-tab" class="tab-content" style="display: none;">
                <div class="distribution-section">
                    <div class="distribution-header">
                        <h3>Управление расходами</h3>
                        <button class="btn-primary" id="add-expense-btn">Добавить расход</button>
                    </div>
                    
                    <div id="expenses-list">
                        <!-- Список расходов будет здесь -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Модальные окна -->
    <div class="modal" id="add-category-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Добавить категорию</div>
                <button class="close-button" id="close-add-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new-category-name">Название категории</label>
                    <input type="text" id="new-category-name" placeholder="Введите название">
                </div>
                <div class="form-group">
                    <label for="new-category-percent">Процент распределения</label>
                    <input type="number" id="new-category-percent" placeholder="%" min="0" max="100" step="1">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancel-add-category">Отмена</button>
                <button class="btn-primary" id="save-add-category">Сохранить</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="edit-category-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Редактировать категорию</div>
                <button class="close-button" id="close-edit-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="edit-category-name">Название категории</label>
                    <input type="text" id="edit-category-name" placeholder="Введите название">
                </div>
                <div class="form-group">
                    <label for="edit-category-percent">Процент распределения</label>
                    <input type="number" id="edit-category-percent" placeholder="%" min="0" max="100" step="1">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancel-edit-category">Отмена</button>
                <button class="btn-primary" id="save-edit-category">Сохранить</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="delete-category-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Удалить категорию</div>
                <button class="close-button" id="close-delete-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Вы уверены, что хотите удалить категорию "<span id="delete-category-name"></span>"?</p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancel-delete-category">Отмена</button>
                <button class="btn-danger" id="confirm-delete-category">Удалить</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="add-expense-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Добавить расход</div>
                <button class="close-button" id="close-expense-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="expense-name">Наименование расхода</label>
                    <input type="text" id="expense-name" placeholder="Введите наименование">
                </div>
                <div class="form-group">
                    <label for="expense-amount">Сумма (₽)</label>
                    <input type="number" id="expense-amount" placeholder="Введите сумму" min="0" step="0.01">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancel-expense">Отмена</button>
                <button class="btn-primary" id="save-expense">Сохранить</button>
            </div>
        </div>
    </div>

    <script>
        // Данные приложения
        let currentDate = new Date();
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let currentDistribution = JSON.parse(localStorage.getItem('currentDistribution')) || {};
        let customCategories = JSON.parse(localStorage.getItem('customCategories')) || [];
        let expenses = JSON.parse(localStorage.getItem('expenses')) || {};
        let currentEditingCategory = null;
        let currentIncomeType = 'salary'; // 'salary' или 'advance'
        
        // Базовые категории доходов
        const baseCategories = {
            income: ['Зарплата', 'Аванс', 'Подарки', 'Инвестиции', 'Прочие доходы'],
            expense: [] // Пустой массив для расходов - пользователь будет добавлять сам
        };
        
        // Получение всех категорий расходов (только пользовательские)
        function getAllExpenseCategories() {
            return [...customCategories];
        }
        
        // Получение ключа для расходов текущего месяца
        function getCurrentMonthExpensesKey() {
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            return `expenses_${year}_${month}`;
        }
        
        // Получение расходов текущего месяца
        function getCurrentMonthExpenses() {
            const key = getCurrentMonthExpensesKey();
            return expenses[key] || [];
        }
        
        // Сохранение расходов текущего месяца
        function saveCurrentMonthExpenses(expensesList) {
            const key = getCurrentMonthExpensesKey();
            expenses[key] = expensesList;
            saveExpenses();
        }
        
        // Получение распределения для текущего типа дохода
        function getCurrentDistribution() {
            const key = `distribution_${currentIncomeType}`;
            return JSON.parse(localStorage.getItem(key)) || {};
        }
        
        // Сохранение распределения для текущего типа дохода
        function saveCurrentDistribution(distribution) {
            const key = `distribution_${currentIncomeType}`;
            localStorage.setItem(key, JSON.stringify(distribution));
        }
        
        // Элементы DOM
        const currentMonthElement = document.getElementById('current-month');
        const prevMonthButton = document.getElementById('prev-month');
        const nextMonthButton = document.getElementById('next-month');
        const totalIncomeElement = document.getElementById('total-income');
        const totalExpensesElement = document.getElementById('total-expenses');
        const totalBalanceElement = document.getElementById('total-balance');
        const incomeSummaryElement = document.getElementById('income-summary');
        const expensesSummaryElement = document.getElementById('expenses-summary');
        const transactionForm = document.getElementById('transaction-form');
        const typeSelect = document.getElementById('type');
        const categorySelect = document.getElementById('category');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const exportButton = document.getElementById('export-btn');
        const importButton = document.getElementById('import-btn');
        const distributionListElement = document.getElementById('distribution-list');
        const applyDistributionButton = document.getElementById('apply-distribution');
        const totalIncomeSummaryElement = document.getElementById('total-income-summary');
        const allocatedSummaryElement = document.getElementById('allocated-summary');
        const availableSummaryElement = document.getElementById('available-summary');
        const usedPercentElement = document.getElementById('used-percent');
        const addCategoryButton = document.getElementById('add-category-btn');
        const copyPrevMonthButton = document.getElementById('copy-prev-month');
        const addExpenseButton = document.getElementById('add-expense-btn');
        const expensesListElement = document.getElementById('expenses-list');
        const incomeTypeButtons = document.querySelectorAll('.income-type-btn');
        
        // Модальные окна
        const addCategoryModal = document.getElementById('add-category-modal');
        const editCategoryModal = document.getElementById('edit-category-modal');
        const deleteCategoryModal = document.getElementById('delete-category-modal');
        const addExpenseModal = document.getElementById('add-expense-modal');
        
        // Кнопки модальных окон
        const closeAddModal = document.getElementById('close-add-modal');
        const cancelAddCategory = document.getElementById('cancel-add-category');
        const saveAddCategory = document.getElementById('save-add-category');
        const closeEditModal = document.getElementById('close-edit-modal');
        const cancelEditCategory = document.getElementById('cancel-edit-category');
        const saveEditCategory = document.getElementById('save-edit-category');
        const closeDeleteModal = document.getElementById('close-delete-modal');
        const cancelDeleteCategory = document.getElementById('cancel-delete-category');
        const confirmDeleteCategory = document.getElementById('confirm-delete-category');
        const closeExpenseModal = document.getElementById('close-expense-modal');
        const cancelExpense = document.getElementById('cancel-expense');
        const saveExpense = document.getElementById('save-expense');
        
        // Инициализация приложения
        function init() {
            updateMonthDisplay();
            updateCategoryOptions();
            updateSummary();
            updateDistribution();
            updateExpenses();
            
            // Установка текущей даты по умолчанию
            document.getElementById('date').valueAsDate = new Date();
            
            // Обработчики событий
            prevMonthButton.addEventListener('click', goToPreviousMonth);
            nextMonthButton.addEventListener('click', goToNextMonth);
            transactionForm.addEventListener('submit', addTransaction);
            typeSelect.addEventListener('change', updateCategoryOptions);
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            exportButton.addEventListener('click', exportToExcel);
            importButton.addEventListener('click', importFromExcel);
            applyDistributionButton.addEventListener('click', applyDistribution);
            copyPrevMonthButton.addEventListener('click', copyFromPreviousMonth);
            addExpenseButton.addEventListener('click', showAddExpenseModal);
            addCategoryButton.addEventListener('click', showAddCategoryModal);
            
            // Переключение типа дохода
            incomeTypeButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const type = e.target.getAttribute('data-type');
                    setIncomeType(type);
                });
            });
            
            // Навигация по сводке
            incomeSummaryElement.addEventListener('click', showIncomeOperations);
            expensesSummaryElement.addEventListener('click', showExpensesOperations);
            
            // Модальные окна
            closeAddModal.addEventListener('click', hideAddCategoryModal);
            cancelAddCategory.addEventListener('click', hideAddCategoryModal);
            saveAddCategory.addEventListener('click', saveNewCategory);
            
            closeEditModal.addEventListener('click', hideEditCategoryModal);
            cancelEditCategory.addEventListener('click', hideEditCategoryModal);
            saveEditCategory.addEventListener('click', saveEditedCategory);
            
            closeDeleteModal.addEventListener('click', hideDeleteCategoryModal);
            cancelDeleteCategory.addEventListener('click', hideDeleteCategoryModal);
            confirmDeleteCategory.addEventListener('click', confirmDeleteCategoryAction);
            
            closeExpenseModal.addEventListener('click', hideAddExpenseModal);
            cancelExpense.addEventListener('click', hideAddExpenseModal);
            saveExpense.addEventListener('click', saveNewExpense);
            
            // Загружаем распределение для текущего типа дохода
            currentDistribution = getCurrentDistribution();
        }
        
        // Обновление отображения текущего месяца
        function updateMonthDisplay() {
            const monthNames = [
                'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
            ];
            currentMonthElement.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
        }
        
        // Переход к предыдущему месяцу
        function goToPreviousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            updateMonthDisplay();
            updateSummary();
            updateDistribution();
            updateExpenses();
        }
        
        // Переход к следующему месяцу
        function goToNextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            updateMonthDisplay();
            updateSummary();
            updateDistribution();
            updateExpenses();
        }
        
        // Установка типа дохода
        function setIncomeType(type) {
            currentIncomeType = type;
            
            // Сохраняем текущее распределение
            saveCurrentDistribution(currentDistribution);
            
            // Загружаем распределение для нового типа дохода
            currentDistribution = getCurrentDistribution();
            
            // Обновление активной кнопки
            incomeTypeButtons.forEach(button => {
                if (button.getAttribute('data-type') === type) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
            
            // Обновление данных
            updateSummary();
            updateDistribution();
        }
        
        // Обновление опций категорий в зависимости от типа операции
        function updateCategoryOptions() {
            const type = typeSelect.value;
            categorySelect.innerHTML = '';
            
            const categories = type === 'income' ? baseCategories.income : getAllExpenseCategories();
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
        }
        
        // Добавление новой транзакции
        function addTransaction(e) {
            e.preventDefault();
            
            const type = typeSelect.value;
            const category = categorySelect.value;
            const amount = parseFloat(document.getElementById('amount').value);
            const date = document.getElementById('date').value;
            
            const transaction = {
                id: Date.now(),
                type,
                category,
                amount,
                incomeType: currentIncomeType,
                description: `${category} - ${date}`,
                date
            };
            
            transactions.push(transaction);
            saveTransactions();
            updateSummary();
            updateDistribution();
            
            // Сброс формы
            transactionForm.reset();
            document.getElementById('date').valueAsDate = new Date();
            updateCategoryOptions();
        }
        
        // Сохранение транзакций в localStorage
        function saveTransactions() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
        }
        
        // Сохранение пользовательских категорий
        function saveCustomCategories() {
            localStorage.setItem('customCategories', JSON.stringify(customCategories));
        }
        
        // Сохранение расходов
        function saveExpenses() {
            localStorage.setItem('expenses', JSON.stringify(expenses));
        }
        
        // Обновление сводки
        function updateSummary() {
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            // Фильтрация транзакций по текущему месяцу и типу дохода
            const monthTransactions = transactions.filter(transaction => {
                const transactionDate = new Date(transaction.date);
                return transactionDate.getMonth() === currentMonth && 
                       transactionDate.getFullYear() === currentYear &&
                       transaction.incomeType === currentIncomeType;
            });
            
            // Расчет сумм
            const totalIncome = monthTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
                
            // Сумма расходов из вкладки "Расходы" для текущего месяца
            const currentMonthExpenses = getCurrentMonthExpenses();
            const totalExpensesAmount = currentMonthExpenses.reduce((sum, expense) => sum + expense.amount, 0);
                
            const balance = totalIncome - totalExpensesAmount;
            
            // Обновление элементов DOM
            totalIncomeElement.textContent = `${totalIncome.toFixed(2)} ₽`;
            totalExpensesElement.textContent = `${totalExpensesAmount.toFixed(2)} ₽`;
            totalBalanceElement.textContent = `${balance.toFixed(2)} ₽`;
        }
        
        // Переключение между вкладками
        function switchTab(tabId) {
            // Обновление активной вкладки
            tabs.forEach(tab => {
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Показать соответствующий контент
            tabContents.forEach(content => {
                if (content.id === `${tabId}-tab`) {
                    content.style.display = 'block';
                } else {
                    content.style.display = 'none';
                }
            });
            
            // Обновление распределения при переходе на вкладку распределения
            if (tabId === 'distribution') {
                updateDistribution();
            }
        }
        
        // Показать операции по доходам
        function showIncomeOperations() {
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            const incomeTransactions = transactions.filter(transaction => {
                const transactionDate = new Date(transaction.date);
                return transactionDate.getMonth() === currentMonth && 
                       transactionDate.getFullYear() === currentYear &&
                       transaction.type === 'income' &&
                       transaction.incomeType === currentIncomeType;
            });
            
            let operationsHTML = `
                <button class="back-button" id="back-to-form">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    Назад к форме
                </button>
            `;
            
            if (incomeTransactions.length === 0) {
                operationsHTML += '<div class="empty-state">Нет операций по доходам за этот месяц</div>';
            } else {
                operationsHTML += '<h3>Операции по доходам</h3><div class="operations-list">';
                
                incomeTransactions.forEach(transaction => {
                    operationsHTML += `
                        <div class="operation-item">
                            <div class="operation-info">
                                <div>${transaction.description}</div>
                                <div class="operation-category">${transaction.category}</div>
                            </div>
                            <div class="operation-amount income">+${transaction.amount.toFixed(2)} ₽</div>
                            <button class="delete-btn" data-id="${transaction.id}">×</button>
                        </div>
                    `;
                });
                
                operationsHTML += '</div>';
            }
            
            // Заменяем содержимое вкладки
            document.getElementById('add-tab').innerHTML = operationsHTML;
            
            // Добавляем обработчик для кнопки "Назад"
            document.getElementById('back-to-form').addEventListener('click', () => {
                restoreAddTransactionForm();
            });
            
            // Добавляем обработчики для кнопок удаления
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = parseInt(e.target.getAttribute('data-id'));
                    deleteTransaction(id);
                });
            });
            
            // Переключаемся на вкладку добавления операций
            switchTab('add');
        }
        
        // Восстановление формы добавления операции
        function restoreAddTransactionForm() {
            const formHTML = `
                <form class="transaction-form" id="transaction-form">
                    <div class="form-group">
                        <label for="type">Тип операции</label>
                        <select id="type" required>
                            <option value="income">Доход</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="category">Категория</label>
                        <select id="category" required>
                            <!-- Категории будут заполняться динамически -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="amount">Сумма (₽)</label>
                        <input type="number" id="amount" min="0" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="date">Дата</label>
                        <input type="date" id="date" required>
                    </div>
                    
                    <button type="submit" class="btn-primary">Добавить операцию</button>
                </form>
                
                <div class="import-export">
                    <button class="btn-secondary" id="export-btn">Экспорт в Excel</button>
                    <button class="btn-secondary" id="import-btn">Импорт из Excel</button>
                </div>
            `;
            
            document.getElementById('add-tab').innerHTML = formHTML;
            
            // Восстанавливаем обработчики событий
            document.getElementById('transaction-form').addEventListener('submit', addTransaction);
            document.getElementById('type').addEventListener('change', updateCategoryOptions);
            document.getElementById('export-btn').addEventListener('click', exportToExcel);
            document.getElementById('import-btn').addEventListener('click', importFromExcel);
            
            // Обновляем категории
            updateCategoryOptions();
            
            // Устанавливаем текущую дату
            document.getElementById('date').valueAsDate = new Date();
        }
        
        // Показать операции по расходам
        function showExpensesOperations() {
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            const expenseTransactions = transactions.filter(transaction => {
                const transactionDate = new Date(transaction.date);
                return transactionDate.getMonth() === currentMonth && 
                       transactionDate.getFullYear() === currentYear &&
                       transaction.type === 'expense' &&
                       transaction.incomeType === currentIncomeType;
            });
            
            let operationsHTML = `
                <button class="back-button" id="back-to-expenses">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    Назад к расходам
                </button>
            `;
            
            if (expenseTransactions.length === 0) {
                operationsHTML += '<div class="empty-state">Нет операций по расходам за этот месяц</div>';
            } else {
                operationsHTML += '<h3>Операции по расходам</h3><div class="operations-list">';
                
                expenseTransactions.forEach(transaction => {
                    operationsHTML += `
                        <div class="operation-item">
                            <div class="operation-info">
                                <div>${transaction.description}</div>
                                <div class="operation-category">${transaction.category}</div>
                            </div>
                            <div class="operation-amount expense">-${transaction.amount.toFixed(2)} ₽</div>
                            <button class="delete-btn" data-id="${transaction.id}">×</button>
                        </div>
                    `;
                });
                
                operationsHTML += '</div>';
            }
            
            // Заменяем содержимое вкладки
            document.getElementById('expenses-tab').innerHTML = operationsHTML;
            
            // Добавляем обработчик для кнопки "Назад"
            document.getElementById('back-to-expenses').addEventListener('click', () => {
                restoreExpensesTab();
            });
            
            // Добавляем обработчики для кнопок удаления
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = parseInt(e.target.getAttribute('data-id'));
                    deleteTransaction(id);
                });
            });
            
            // Переключаемся на вкладку расходов
            switchTab('expenses');
        }
        
        // Восстановление вкладки расходов
        function restoreExpensesTab() {
            const expensesHTML = `
                <div class="distribution-section">
                    <div class="distribution-header">
                        <h3>Управление расходами</h3>
                        <button class="btn-primary" id="add-expense-btn">Добавить расход</button>
                    </div>
                    
                    <div id="expenses-list">
                        <!-- Список расходов будет здесь -->
                    </div>
                </div>
            `;
            
            document.getElementById('expenses-tab').innerHTML = expensesHTML;
            
            // Восстанавливаем обработчики событий
            document.getElementById('add-expense-btn').addEventListener('click', showAddExpenseModal);
            
            // Обновляем список расходов
            updateExpenses();
        }
        
        // Удаление транзакции
        function deleteTransaction(id) {
            transactions = transactions.filter(transaction => transaction.id !== id);
            saveTransactions();
            updateSummary();
            updateDistribution();
            
            // Обновляем отображение операций
            if (document.getElementById('back-to-form')) {
                showIncomeOperations();
            } else if (document.getElementById('back-to-expenses')) {
                showExpensesOperations();
            }
        }
        
        // Обновление распределения доходов
        function updateDistribution() {
            distributionListElement.innerHTML = '';
            
            // Получение общего дохода за текущий месяц и тип дохода
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            const monthIncome = transactions
                .filter(t => t.type === 'income' && 
                    new Date(t.date).getMonth() === currentMonth && 
                    new Date(t.date).getFullYear() === currentYear &&
                    t.incomeType === currentIncomeType)
                .reduce((sum, t) => sum + t.amount, 0);
            
            // Сумма расходов из вкладки "Расходы" для текущего месяца
            const currentMonthExpenses = getCurrentMonthExpenses();
            const totalExpensesAmount = currentMonthExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            
            // Баланс (доходы минус расходы)
            const balance = monthIncome - totalExpensesAmount;
            
            // Получение уже распределенных сумм
            const allocatedAmount = transactions
                .filter(t => t.type === 'expense' && 
                    new Date(t.date).getMonth() === currentMonth && 
                    new Date(t.date).getFullYear() === currentYear &&
                    t.incomeType === currentIncomeType &&
                    t.description.includes('Планируемые расходы'))
                .reduce((sum, t) => sum + t.amount, 0);
            
            // Доступно для распределения (баланс минус уже распределенные суммы)
            const availableForDistribution = balance - allocatedAmount;
            
            // Расчет суммы распределения в процентах
            const totalPercent = Object.values(currentDistribution).reduce((sum, val) => sum + val, 0);
            
            // Если нет категорий, показываем сообщение
            if (Object.keys(currentDistribution).length === 0) {
                distributionListElement.innerHTML = `
                    <div class="empty-state">
                        <p>Нет добавленных категорий распределения</p>
                        <p>Нажмите на кнопку "+", чтобы добавить первую категорию</p>
                    </div>
                `;
            } else {
                // Отображение распределения по категориям
                Object.keys(currentDistribution).forEach(category => {
                    const percent = currentDistribution[category] || 0;
                    const amount = availableForDistribution * (percent / 100);
                    
                    const distributionItem = document.createElement('div');
                    distributionItem.className = 'distribution-item';
                    
                    distributionItem.innerHTML = `
                        <div class="distribution-category">${category}</div>
                        <div class="distribution-controls">
                            <input type="number" class="distribution-percent" data-category="${category}" 
                                   value="${percent}" min="0" max="100" step="1"> %
                            <div class="distribution-amount">${amount.toFixed(2)} ₽</div>
                            <div class="category-actions">
                                <button class="btn-success action-btn edit-category-btn" data-category="${category}">✎</button>
                                <button class="btn-danger action-btn delete-category-btn" data-category="${category}">×</button>
                            </div>
                        </div>
                    `;
                    
                    distributionListElement.appendChild(distributionItem);
                    
                    // Прогресс-бар
                    const progressBar = document.createElement('div');
                    progressBar.className = 'progress-bar';
                    const progressFill = document.createElement('div');
                    progressFill.className = 'progress-fill';
                    progressFill.style.width = `${percent}%`;
                    progressBar.appendChild(progressFill);
                    
                    distributionItem.appendChild(progressBar);
                    
                    // Добавление обработчика событий для поля ввода процентов
                    const percentInput = distributionItem.querySelector('.distribution-percent');
                    percentInput.addEventListener('change', (e) => {
                        const category = e.target.getAttribute('data-category');
                        const value = parseFloat(e.target.value) || 0;
                        currentDistribution[category] = value;
                        saveCurrentDistribution(currentDistribution);
                        updateDistribution();
                    });
                    
                    // Добавление обработчика для кнопки редактирования категории
                    const editButton = distributionItem.querySelector('.edit-category-btn');
                    editButton.addEventListener('click', (e) => {
                        const category = e.target.getAttribute('data-category');
                        showEditCategoryModal(category);
                    });
                    
                    // Добавление обработчика для кнопки удаления категории
                    const deleteButton = distributionItem.querySelector('.delete-category-btn');
                    deleteButton.addEventListener('click', (e) => {
                        const category = e.target.getAttribute('data-category');
                        showDeleteCategoryModal(category);
                    });
                });
            }
            
            // Обновление сводки распределения
            totalIncomeSummaryElement.textContent = `${monthIncome.toFixed(2)} ₽`;
            allocatedSummaryElement.textContent = `${allocatedAmount.toFixed(2)} ₽`;
            availableSummaryElement.textContent = `${availableForDistribution.toFixed(2)} ₽`;
            usedPercentElement.textContent = `${totalPercent}%`;
            
            // Предупреждение, если распределено больше 100%
            if (totalPercent > 100) {
                const warningElement = document.createElement('div');
                warningElement.style.color = '#dc3545';
                warningElement.style.marginTop = '10px';
                warningElement.style.textAlign = 'center';
                warningElement.textContent = 'Внимание: распределено более 100% доходов!';
                distributionListElement.appendChild(warningElement);
            }
        }
        
        // Показать модальное окно добавления категории
        function showAddCategoryModal() {
            document.getElementById('new-category-name').value = '';
            document.getElementById('new-category-percent').value = '';
            addCategoryModal.classList.add('show');
        }
        
        // Скрыть модальное окно добавления категории
        function hideAddCategoryModal() {
            addCategoryModal.classList.remove('show');
        }
        
        // Сохранить новую категорию
        function saveNewCategory() {
            const categoryName = document.getElementById('new-category-name').value.trim();
            const percent = parseFloat(document.getElementById('new-category-percent').value) || 0;
            
            if (!categoryName) {
                alert('Введите название категории');
                return;
            }
            
            if (percent < 0 || percent > 100) {
                alert('Процент должен быть от 0 до 100');
                return;
            }
            
            // Проверяем, существует ли уже такая категория
            if (currentDistribution.hasOwnProperty(categoryName)) {
                alert('Категория с таким названием уже существует');
                return;
            }
            
            // Добавляем категорию в распределение
            currentDistribution[categoryName] = percent;
            
            // Добавляем в список пользовательских категорий
            if (!customCategories.includes(categoryName)) {
                customCategories.push(categoryName);
                saveCustomCategories();
                updateCategoryOptions();
            }
            
            saveCurrentDistribution(currentDistribution);
            updateDistribution();
            hideAddCategoryModal();
        }
        
        // Показать модальное окно редактирования категории
        function showEditCategoryModal(categoryName) {
            currentEditingCategory = categoryName;
            document.getElementById('edit-category-name').value = currentEditingCategory;
            document.getElementById('edit-category-percent').value = currentDistribution[currentEditingCategory];
            editCategoryModal.classList.add('show');
        }
        
        // Скрыть модальное окно редактирования категории
        function hideEditCategoryModal() {
            editCategoryModal.classList.remove('show');
            currentEditingCategory = null;
        }
        
        // Сохранить отредактированную категорию
        function saveEditedCategory() {
            const newCategoryName = document.getElementById('edit-category-name').value.trim();
            const newPercent = parseFloat(document.getElementById('edit-category-percent').value) || 0;
            
            if (!newCategoryName) {
                alert('Введите название категории');
                return;
            }
            
            if (newPercent < 0 || newPercent > 100) {
                alert('Процент должен быть от 0 до 100');
                return;
            }
            
            // Если название изменилось, создаем новую категорию и удаляем старую
            if (newCategoryName !== currentEditingCategory) {
                // Удаляем старую категорию
                delete currentDistribution[currentEditingCategory];
                
                // Обновляем список пользовательских категорий
                if (customCategories.includes(currentEditingCategory)) {
                    customCategories = customCategories.filter(cat => cat !== currentEditingCategory);
                    customCategories.push(newCategoryName);
                    saveCustomCategories();
                    updateCategoryOptions();
                }
            }
            
            // Обновляем категорию
            currentDistribution[newCategoryName] = newPercent;
            
            saveCurrentDistribution(currentDistribution);
            updateDistribution();
            hideEditCategoryModal();
        }
        
        // Показать модальное окно удаления категории
        function showDeleteCategoryModal(categoryName) {
            currentEditingCategory = categoryName;
            document.getElementById('delete-category-name').textContent = currentEditingCategory;
            deleteCategoryModal.classList.add('show');
        }
        
        // Скрыть модальное окно удаления категории
        function hideDeleteCategoryModal() {
            deleteCategoryModal.classList.remove('show');
            currentEditingCategory = null;
        }
        
        // Подтвердить удаление категории
        function confirmDeleteCategoryAction() {
            if (!currentEditingCategory) return;
            
            // Удаляем категорию из распределения
            delete currentDistribution[currentEditingCategory];
            
            // Удаляем из списка пользовательских категорий
            if (customCategories.includes(currentEditingCategory)) {
                customCategories = customCategories.filter(cat => cat !== currentEditingCategory);
                saveCustomCategories();
                updateCategoryOptions();
            }
            
            saveCurrentDistribution(currentDistribution);
            updateDistribution();
            hideDeleteCategoryModal();
        }
        
        // Показать модальное окно добавления расхода
        function showAddExpenseModal() {
            document.getElementById('expense-name').value = '';
            document.getElementById('expense-amount').value = '';
            addExpenseModal.classList.add('show');
        }
        
        // Скрыть модальное окно добавления расхода
        function hideAddExpenseModal() {
            addExpenseModal.classList.remove('show');
        }
        
        // Сохранить новый расход
        function saveNewExpense() {
            const name = document.getElementById('expense-name').value.trim();
            const amount = parseFloat(document.getElementById('expense-amount').value) || 0;
            
            if (!name) {
                alert('Введите наименование расхода');
                return;
            }
            
            if (amount <= 0) {
                alert('Введите корректную сумму');
                return;
            }
            
            const expense = {
                id: Date.now(),
                name,
                amount,
                date: new Date().toISOString().split('T')[0]
            };
            
            const currentMonthExpenses = getCurrentMonthExpenses();
            currentMonthExpenses.push(expense);
            saveCurrentMonthExpenses(currentMonthExpenses);
            updateExpenses();
            updateSummary();
            updateDistribution();
            hideAddExpenseModal();
        }
        
        // Обновление списка расходов
        function updateExpenses() {
            expensesListElement.innerHTML = '';
            
            const currentMonthExpenses = getCurrentMonthExpenses();
            
            if (currentMonthExpenses.length === 0) {
                expensesListElement.innerHTML = '<div class="empty-state">Нет добавленных расходов</div>';
                return;
            }
            
            currentMonthExpenses.forEach(expense => {
                const expenseItem = document.createElement('div');
                expenseItem.className = 'distribution-item';
                
                expenseItem.innerHTML = `
                    <div class="distribution-category">${expense.name}</div>
                    <div class="distribution-controls">
                        <div class="distribution-amount">${expense.amount.toFixed(2)} ₽</div>
                        <button class="btn-danger action-btn delete-expense-btn" data-id="${expense.id}">×</button>
                    </div>
                `;
                
                expensesListElement.appendChild(expenseItem);
                
                // Добавление обработчика для кнопки удаления расхода
                const deleteButton = expenseItem.querySelector('.delete-expense-btn');
                deleteButton.addEventListener('click', (e) => {
                    const id = parseInt(e.target.getAttribute('data-id'));
                    deleteExpense(id);
                });
            });
        }
        
        // Удаление расхода
        function deleteExpense(id) {
            const currentMonthExpenses = getCurrentMonthExpenses();
            const updatedExpenses = currentMonthExpenses.filter(expense => expense.id !== id);
            saveCurrentMonthExpenses(updatedExpenses);
            updateExpenses();
            updateSummary();
            updateDistribution();
        }
        
        // Копирование распределения из предыдущего месяца
        function copyFromPreviousMonth() {
            const prevMonth = new Date(currentDate);
            prevMonth.setMonth(prevMonth.getMonth() - 1);
            
            const prevMonthKey = `distribution_${currentIncomeType}_${prevMonth.getFullYear()}_${prevMonth.getMonth()}`;
            const prevDistribution = JSON.parse(localStorage.getItem(prevMonthKey));
            
            if (prevDistribution) {
                currentDistribution = {...prevDistribution};
                saveCurrentDistribution(currentDistribution);
                updateDistribution();
                updateCategoryOptions();
                alert('Распределение скопировано из предыдущего месяца!');
            } else {
                alert('Нет данных о распределении за предыдущий месяц');
            }
        }
        
        // Применение распределения (создание транзакций)
        function applyDistribution() {
            // Проверяем, есть ли категории для распределения
            if (Object.keys(currentDistribution).length === 0) {
                alert('Нет категорий для распределения. Сначала добавьте категории.');
                return;
            }
            
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            // Получение общего дохода за текущий месяц и тип дохода
            const monthIncome = transactions
                .filter(t => t.type === 'income' && 
                    new Date(t.date).getMonth() === currentMonth && 
                    new Date(t.date).getFullYear() === currentYear &&
                    t.incomeType === currentIncomeType)
                .reduce((sum, t) => sum + t.amount, 0);
            
            // Сумма расходов из вкладки "Расходы" для текущего месяца
            const currentMonthExpenses = getCurrentMonthExpenses();
            const totalExpensesAmount = currentMonthExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            
            // Баланс (доходы минус расходы)
            const balance = monthIncome - totalExpensesAmount;
            
            // Получение уже распределенных сумм
            const allocatedAmount = transactions
                .filter(t => t.type === 'expense' && 
                    new Date(t.date).getMonth() === currentMonth && 
                    new Date(t.date).getFullYear() === currentYear &&
                    t.incomeType === currentIncomeType &&
                    t.description.includes('Планируемые расходы'))
                .reduce((sum, t) => sum + t.amount, 0);
            
            // Доступно для распределения (баланс минус уже распределенные суммы)
            const availableForDistribution = balance - allocatedAmount;
            
            // Удаляем старые распределенные транзакции
            transactions = transactions.filter(t => 
                !(t.type === 'expense' && 
                  new Date(t.date).getMonth() === currentMonth && 
                  new Date(t.date).getFullYear() === currentYear &&
                  t.incomeType === currentIncomeType &&
                  t.description.includes('Планируемые расходы')));
            
            // Создание транзакций для каждой категории распределения
            Object.keys(currentDistribution).forEach(category => {
                const percent = currentDistribution[category];
                if (percent > 0) {
                    const amount = availableForDistribution * (percent / 100);
                    if (amount > 0) {
                        const transaction = {
                            id: Date.now() + Math.floor(Math.random() * 1000),
                            type: 'expense',
                            category: category,
                            amount: amount,
                            incomeType: currentIncomeType,
                            description: `Планируемые расходы: ${category}`,
                            date: `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-15`
                        };
                        
                        transactions.push(transaction);
                    }
                }
            });
            
            saveTransactions();
            updateSummary();
            updateDistribution();
            alert('Распределение применено! Созданы транзакции для запланированных расходов.');
        }
        
        // Экспорт данных в Excel
        function exportToExcel() {
            // Создание CSV-строки
            let csv = 'ID,Тип,Категория,Сумма,Тип дохода,Описание,Дата\n';
            
            transactions.forEach(transaction => {
                csv += `${transaction.id},${transaction.type},${transaction.category},${transaction.amount},${transaction.incomeType},"${transaction.description}",${transaction.date}\n`;
            });
            
            // Создание и скачивание файла
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `семейный_бюджет_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Импорт данных из Excel
        function importFromExcel() {
            // Создание элемента input для выбора файла
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.csv,.xlsx,.xls';
            fileInput.style.visibility = 'hidden';
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const csvData = event.target.result;
                        const lines = csvData.split('\n');
                        
                        // Пропускаем заголовок и обрабатываем данные
                        const importedTransactions = [];
                        
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;
                            
                            // Простой парсинг CSV (для сложных случаев лучше использовать библиотеку)
                            const parts = line.split(',');
                            if (parts.length >= 7) {
                                const transaction = {
                                    id: parseInt(parts[0]) || Date.now() + i,
                                    type: parts[1],
                                    category: parts[2],
                                    amount: parseFloat(parts[3]),
                                    incomeType: parts[4] || 'salary',
                                    description: parts[5].replace(/"/g, ''),
                                    date: parts[6]
                                };
                                
                                importedTransactions.push(transaction);
                            }
                        }
                        
                        // Добавляем импортированные транзакции
                        transactions = [...transactions, ...importedTransactions];
                        saveTransactions();
                        updateSummary();
                        updateDistribution();
                        
                        alert(`Успешно импортировано ${importedTransactions.length} операций`);
                    } catch (error) {
                        alert('Ошибка при импорте файла. Убедитесь, что файл имеет правильный формат.');
                        console.error(error);
                    }
                };
                
                reader.readAsText(file);
            });
            
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        }
        
        // Запуск приложения
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>